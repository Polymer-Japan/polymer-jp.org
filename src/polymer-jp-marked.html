<link rel="import" href="../components/polymer/polymer-element.html">
<link rel="import" href="../components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../components/marked-element/marked-element.html">
<link rel="import" href="../components/prism-element/prism-highlighter.html">
<link rel="import" href="../components/prism-element/prism-theme-default.html">
<link rel="import" href="../components/sanitize-element/sanitize-element.html">
<link rel="import" href="../components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../components/app-layout/app-header/app-header.html">
<link rel="import" href="../components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../components/iron-media-query/iron-media-query.html">
<link rel="import" href="../components/paper-input/paper-textarea.html">
<link rel="import" href="../components/paper-input/paper-input.html">
<link rel="import" href="../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../components/paper-card/paper-card.html">
<link rel="import" href="../components/paper-item/paper-item.html">
<link rel="import" href="../components/paper-listbox/paper-listbox.html">
<link rel="import" href="../components/paper-button/paper-button.html">
<link rel="import" href="../components/polymerfire/firebase-storage-multiupload.html">
<link rel="import" href="../components/polymerfire/firebase-storage-upload-task.html">

<link rel="import" href="https://poly-style.appspot.com?id=github-markdown&url=https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.min.css">

<script src="https://cdn.rawgit.com/emojione/emojione/2.2.7/lib/js/emojione.min.js"></script>
<link rel="stylesheet" href="https://cdn.rawgit.com/emojione/emojione/2.2.7/assets/css/emojione.min.css">

<dom-module id="polymer-jp-marked">
  <template>
    <style include="github-markdown prism-theme-default">
      :host {
        display: block;
        --header-height: 64px;
        --header-bg-url: '';
      }
      app-toolbar paper-icon-button {
        color: white;
      }
      app-header {
        height: var(--header-height);
        color: #fff;
        background-color: #337ab7;
        --app-header-background-front-layer: { background-image: var(--header-bg-url); };
      }
      div[main-title] {
        font-family: 'Roboto Slab',serif;
        font-size: 20px;
        font-weight: 700;
        white-space: nowrap;
      }
      marked-element {
        margin: 15px;
      }
      [slot="markdown-html"] pre {
        padding: 0.5em 1em;
        margin-top: 5px;
        margin-left: 20px;
        margin-right: 20px;
        background-color: #f7f7f7;
        border-radius: 3px;
        overflow-x: auto;
        line-height: 1.1;
        font-family: Consolas,Liberation Mono,Menlo,Courier,monospace;
      }
      [slot="markdown-html"] code {
        padding: 1px;
        margin: 1px;
        background-color: #f7f7f7;
      }
      [slot="markdown-html"] pre code {
        padding: 0;
      }
      [slot="markdown-html"] blockquote {
        border-left: solid 4px #ddd;
        padding-left: 10px;
      }
      [slot="markdown-html"] h1 {
      }
      [slot="markdown-html"] h2 {
        border-bottom: solid 1px #f50057;
      }
      [slot="markdown-html"] a {
        color: #337ab7;
        text-decoration: none
      }
      [slot="markdown-html"] a:hover, [slot="markdown-html"] a:focus {
        color: #23527c;
        text-decoration: underline
      }
      [slot="markdown-html"] a:focus {
        outline: 5px auto -webkit-focus-ring-color;
        outline-offset: -2px
      }
      main[slot="markdown-html"]{
        color: #4a4a4a;
      }
      [slot="markdown-html"] em {
        font-family: Helvetica Neue,Helvetica,"ヒラギノ角ゴ ProN W3",Hiragino Kaku Gothic ProN,"游ゴシック",YuGothic,sans-serif;
        font-style: italic;
      }
      .emojione {
        width: 22px;
        height: 22px;
        vertical-align: bottom;
      }
      paper-listbox {
        margin-top: 15px;
        float: right;
      }
      paper-item {
        font-size: 0.9em;
        --paper-item-min-height: 24px;
        cursor: pointer;
      }
      paper-item span::before { content: "・"; }
    </style>

    <iron-media-query query="min-width: 1000px" query-matches="{{wideScreen}}"></iron-media-query>

    <firebase-storage-multiupload
      path="/files" upload-tasks="{{_uploadTasks}}"></firebase-storage-multiupload>
    <template is="dom-repeat" items="[[_uploadTasks]]">
      <firebase-storage-upload-task task="[[item]]" metadata="{{_metaData}}"></firebase-storage-upload-task>
    </template>

    <prism-highlighter></prism-highlighter>

    <sanitize-element config="[[_sanitizeConfig]]" sanitizer="{{_sanitizer}}"></sanitize-element>

    <app-header-layout fullbreed>

      <app-header fixed shadow effects="parallax-background">
        <app-toolbar>
          <div main-title>[[doc.title]]</div>
          <template is="dom-if" if="[[doc.url]]">
            <a href="[[_getReposUrl(doc.url)]]">
              <paper-icon-button icon="i:github"></paper-icon-button>
            </a>
          </template>
          <paper-icon-button icon="i:mode-edit" toggles active="{{_edit}}"></paper-icon-button>
        </app-toolbar>
      </app-header>

      <template is="dom-if" if="[[wideScreen]]">
        <paper-listbox align="left">
          <template is="dom-repeat" items="[[toc]]">
            <paper-item on-tap="_scroll"><li>[[item.title]]</li></paper-item>
          </template>
        </paper-listbox>
      </template>

      <marked-element markdown="[[_markdown]]" sanitize sanitizer="[[_sanitizer]]" on-marked-render-complete="_clearToc">
        <main class="markdown-body" slot="markdown-html"></main>
      </marked-element>

      <template is="dom-if" if="[[_edit]]">
        <div style="margin: 5px; padding: 10px;">
          <paper-input always-float-label label="Title" value="{{doc.title}}" hidden="[[!_edit]]"></paper-input>
          <paper-input always-float-label label="Description" value="{{doc.desc}}" hidden="[[!_edit]]"></paper-input>
          <paper-input always-float-label label="Order" value="{{doc.order}}" hidden="[[!_edit]]"></paper-input>
          <paper-textarea always-float-label label="Contents" value="{{doc.contents}}" hidden="[[!_edit]]"
            on-drop="_onTextareaDrop" on-paste="_onTextareaPaste"
          ></paper-textarea>
          <paper-input always-float-label label="Background URL" value="{{doc.bgurl}}" hidden="[[!_edit]]"></paper-input>
          <paper-input always-float-label label="Markdown URL" value="{{doc.url}}" hidden="[[!_edit]]"></paper-input>
        </div>
      </template>

    </app-header-layout>

  </template>
  <script>
    class PolymerJpMarked extends Polymer.Element {
      static get is() { return 'polymer-jp-marked' }
      static get properties() {
        return {
          doc: Object,
          toc: Array,
          _toc: {
            type: Array,
            value: [],
          },
          _markdown: {
            type: String,
            computed: "_emojify(doc.contents)"
          },
          _sanitizeConfig: {
            type: Object,
            value: {
              elements: ['a','img','md-button','md-card'],
              attributes: {
                a: ['href','title'],
                img: ['class','src'],
                'md-button': ['color'],
                'md-card': ['image','title','sub-title','desc','button']
              },
              protocols: {
                a:{ href: ['http','https'] }
              }
            },
          },
          _allowedTypes: {
            type: Array,
            value: [
              'image/jpeg',
              'image/png',
              'image/jpg',
              'image/gif'
            ]
          },
          _progressText: {
            type: String,
            value: '![Uploading file...]()'
          },
          _metaData: {
            type: Object,
            observer: '_metaDataChanged'
          }
        }
      }
      static get observers() {
        return [
          '_contentsChanged(doc.*)',
          '_docUrlChanged(doc.url)',
          '_bgUrlChanged(doc.bgurl)'
        ]
      }
      _scroll(e){
        this.shadowRoot.getElementById(e.model.item.id).scrollIntoView();
      }
      ready(){
        super.ready();
        this.shadowRoot.querySelector('marked-element').renderer=op=>{
          // 外部リンクは_blankで。
          op.link = (href,title,text) => {
            const titleAttr = title ? ` title="${title}"` : '';
            const targetAttr = href.indexOf('http')==0 ? ' target="_blank"' : '';
            return `<a href="${href}"${titleAttr}${targetAttr}>${text}</a>`;
          }
          // 改行の自動変換
          op.paragraph = text => {
            return text ? '<p>'+text.replace(/\r?\n/g, '<br>')+'</p>\n' : '';
          }
          // TOCの取得
          op.heading = (text, level, raw) => {
            const id = encodeURI(raw).toLowerCase().replace(/ /g, '-');
            if(level == 2) this.push('_toc',{id: id, title: text});
            return `<h${level} id="${id}">${text}</h${level}>\n`;
          }
        }
      }
      _clearToc(e){
        this.set('toc',this._toc);
        this.set('_toc',[]);
      }
      _docUrlChanged(url){
        if(url)
          this.shadowRoot.querySelector('marked-element')._request(url);
      }
      _bgUrlChanged(url){
        if(url){
          this.updateStyles({
            '--header-height': '224px',
            '--header-bg-url': `url(${url})`,
          });
        }else{
          this.updateStyles({
            '--header-height': 'initial',
            '--header-bg-url': 'initial',
          });
        }
      }
      _getReposUrl(url){
        const u = url.split('/');
        return u[2]=='cdn.rawgit.com' ? ['https://github.com/',u[3],u[4],'blob','master'].concat(u.slice(6)).join('/') : url;
      }
      _contentsChanged(e){
        if(e.path.lastIndexOf('doc.')==0 && this._edit){
          let data = {};
          const key = e.path.substr(4);
          data[key]= key == 'order' ? parseInt(e.value) : e.value;
          firebase.firestore().collection('docs').doc(e.base.__id__).update(data);
        }
      }
      _emojify(contents){
        if (contents) return emojione.toImage(contents)
      }
      _onTextareaDrop(e){
        e.stopPropagation()
        e.preventDefault()
        this.shadowRoot.querySelector('firebase-storage-multiupload').upload(
          Array.from(e.dataTransfer.files)
               .filter(f=>this._allowedTypes.indexOf(f.type) !== -1)
               .map(f=>{this._insertImageText(this._progressText); return f;}));
      }
      _onTextareaPaste(e){
        this.shadowRoot.querySelector('firebase-storage-multiupload').upload(
          Array.from(e.clipboardData.items || e.clipboardData.files || [])
               .filter(f=>this._allowedTypes.indexOf(f.type) !== -1)
               .map(i=>{this._insertImageText(this._progressText); return i.getAsFile();}));
      }
      _metaDataChanged(meta){
        // TODO: アップロード時にファイル名を変更したい
        if(meta) this._insertImageText(`![${meta.name}](${meta.downloadURLs[0]})\n`);
      }
      _insertImageText(text){
        const el = this.shadowRoot.querySelector('paper-textarea')
                       .shadowRoot.querySelector('iron-autogrow-textarea');
        const pos = el.selectionStart;
        const ptext = this._progressText;
        let offset = 0;
        if(this.doc.contents.substr(pos - ptext.length, ptext.length) == ptext)
          offset = ptext.length;
        this.set('doc.contents',this.doc.contents.substring(0, pos - offset) + text +
                        this.doc.contents.substring(pos, this.doc.contents.length));
        el.selectionStart = pos + text.length - offset;
        el.selectionEnd = pos + text.length - offset;
        el.focus();
      }
    }
    customElements.define(PolymerJpMarked.is, PolymerJpMarked)
  </script>
</dom-module>

<dom-module id="md-button">
  <template>
    <style>
      paper-button {
        color: white;
        background-color: var(--button-color,#337ab7);
      }
    </style>
    <paper-button><slot></slot></paper-button>
  </template>
  <script>
    class MdButton extends Polymer.Element {
      static get is() { return 'md-button' }
      static get properties() {
        return {
          color: {
            type: String,
            observer: '_colorChanged'
          }
        }
      }
      _colorChanged(color){
        this.updateStyles({'--button-color': color});
      }
    }
    customElements.define(MdButton.is,MdButton)
  </script>
</dom-module>

<dom-module id="md-card">
  <template>
    <style>
      :host {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      paper-card {
	      max-width: 500px;
        --paper-card-header-color: white;
      }
      .cafe-header { @apply --paper-font-headline; }
      .cafe-light { color: var(--paper-grey-600); }
      .cafe-location {
        float: right;
        font-size: 15px;
        vertical-align: middle;
      }
      .cafe-reserve { color: var(--google-blue-500); }
    </style>
    <paper-card image="[[image]]" heading="[[title]]">
      <div class="card-content">
        <p>[[subTitle]]</p>
        <p class="cafe-light">[[desc]]</p>
      </div>
      <div class="card-actions">
        <div class="horizontal justified">
          <paper-button class="cafe-reserve">[[button]]</paper-button>
        </div>
      </div>
    </paper-card>
  </template>
  <script>
    class MdCard extends Polymer.Element {
      static get is() { return 'md-card' }
      static get properties() {
        return {
          image: String,
          title: String,
          subTitle: String,
          desc: String,
          button: String
        }
      }
    }
    customElements.define(MdCard.is,MdCard)
  </script>
</dom-module>
