<link rel="import" href="../components/polymer/polymer-element.html">
<link rel="import" href="../components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../components/marked-element/marked-element.html">
<link rel="import" href="../components/prism-element/prism-highlighter.html">
<link rel="import" href="../components/prism-element/prism-theme-default.html">
<link rel="import" href="../components/sanitize-element/sanitize-element.html">
<link rel="import" href="../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../components/app-layout/app-header/app-header.html">
<link rel="import" href="../components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../components/paper-input/paper-textarea.html">
<link rel="import" href="../components/paper-input/paper-input.html">

<link rel="import" href="https://poly-style.appspot.com?id=github-markdown&url=https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.min.css">

<script src="https://cdn.rawgit.com/emojione/emojione/2.2.7/lib/js/emojione.min.js"></script>
<link rel="stylesheet" href="https://cdn.rawgit.com/emojione/emojione/2.2.7/assets/css/emojione.min.css">

<dom-module id="polymer-jp-marked-theme">
  <template>
    <style>
      .token.tag {
        color: navy;
      }
    </style>
  </template>
</dom-module>

<dom-module id="polymer-jp-marked">
  <template>
    <style include="github-markdown prism-theme-default">
      :host {
        display: block;
      }
      div[main-title] {
        white-space: nowrap;
        color: white;
      }
      app-toolbar paper-icon-button {
        color: white;
      }
      app-header {
        color: #fff;
        background-color: #337ab7;
        --app-header-background-front-layer: {
          background-image: url(https://images.unsplash.com/photo-1493780474015-ba834fd0ce2f?w=1400);
        };
      }
      [slot="markdown-html"] pre {
        padding: 0.5em 1em;
        margin-top: 5px;
        margin-left: 20px;
        margin-right: 20px;
        background-color: #f7f7f7;
        border-radius: 3px;
        overflow-x: auto;
        line-height: 1.1;
        font-family: Consolas,Liberation Mono,Menlo,Courier,monospace;
      }
      [slot="markdown-html"] code {
        padding: 1px;
        margin: 1px;
        background-color: #f7f7f7;
      }
      [slot="markdown-html"] pre code {
        padding: 0;
      }
      [slot="markdown-html"] blockquote {
        border-left: solid 4px #ddd;
        padding-left: 10px;
      }
      [slot="markdown-html"] h1 {
      }
      [slot="markdown-html"] h2 {
        border-bottom: solid 1px #f50057;
      }
      [slot="markdown-html"] a {
        color: #337ab7;
        text-decoration: none
      }
      [slot="markdown-html"] a:hover, [slot="markdown-html"] a:focus {
        color: #23527c;
        text-decoration: underline
      }
      [slot="markdown-html"] a:focus {
        outline: 5px auto -webkit-focus-ring-color;
        outline-offset: -2px
      }
      main[slot="markdown-html"]{
        color: #4a4a4a;
      }
      [slot="markdown-html"] em {
        font-family: Helvetica Neue,Helvetica,"ヒラギノ角ゴ ProN W3",Hiragino Kaku Gothic ProN,"游ゴシック",YuGothic,sans-serif;
        font-style: italic;
      }
      .emojione {
        width: 22px;
        height: 22px;
        vertical-align: bottom;
      }
    </style>

    <prism-highlighter></prism-highlighter>

    <sanitize-element config='{
                              "elements":["a","img"],
                              "attributes":{"a":["href","title"],"img":["class","src"]},
                              "protocols":{"a":{"href":["http","https"]}}
                              }' sanitizer="{{sanitizer}}"></sanitize-element>

    <app-header-layout fullbreed>

      <app-header slot="header" effects="blend-background parallax-background" shadow>
        <app-toolbar style="height: 400px;">
          <div main-title>[[doc.title]]</div>
          <div class="flex"></div>
          <template is="dom-if" if="[[!doc.contents]]">
            <paper-icon-button icon="i:github"></paper-icon-button>
          </template>
          <template is="dom-if" if="[[doc.contents]]">
            <paper-icon-button icon="i:mode-edit" toggles active="{{_edit}}"></paper-icon-button>
          </template>
        </app-toolbar>
      </app-header>

      <template is="dom-if" if="[[!routeData.key]]">
        <!-- ---------------------- dummy start -------------------------- -->
        <h2 style="margin-top: 20px; text-align: center;">Polymer Japan Meetup #1 11/04</h2>
        <h5 style="margin-top: 20px; text-align: center;">ミートアップ & ハンズオン！</h5>
        <div class="horizontal-center">
          <div style="padding: 20px;">
            <span style="font-size: 0.9em;">
              イベントは、Polymer及びWeb Componentsの基本的な紹介に始まり、ハンズオン形式での開発体験、プロダクションへの導入案内、LT&懇親会と充実した構成となっています。すでにPolymerを使っている方、これから使おうと考えている方、Polymer及びWeb Componentsについて聞いたことはあるけど何だか分からないといった方までご満足いただける内容だと思います。
            </span>
          </div>
        </div>
        <div class="horizontal-center">
          <img src="assets/polymer-project-top.png" width="80%" style="margin-top: 20px; margin-right: auto; margin-left: auto;">
        </div>
        <div class="box">
          <div style="padding: 20px; margin-bottom: 20px;">
            <h4>Polymerとは</h4>
            <span style="font-size: 0.9em;">
              Polymerは、Web標準APIをベースにしたWeb Componentsの開発をサポートするフロントエンドのJavascriptライブラリであり、独自のHTMLエレメント(タグ)を開発者がより簡単に作成できるようにします。<br>
              独自のHTMLエレメントが作成できるようになることで、一度作成したUIコンポーネントや他の開発者が作成したエレメントを、通常のHTMLタグを記述するように宣言的構文によって簡単に再利用でき、複雑なWebアプリケーションをより効率的に作成できるようになります。
              Polymerは、単にWeb標準のWeb Componentsの実装をサポートすることにとどまらず、データバインディングやテンプレート、オブザーバーといった他の標準的なモダンJSライブラリによって提供される機能をも包含しており、効率的なWeb開発をサポートするライブラリとしても高度な機能を単独で備えています。
            </span>
          </div>
        </div>
        <!-- ---------------------- dummy end ------------------------------ -->
      </template>


      <!--
           TODO: scriptの読み込みタイミングが制御できず二重で書いている
         -->
      <template is="dom-if" if="[[!doc.url]]">
        <marked-element markdown="[[_markdown]]" sanitize sanitizer="[[sanitizer]]">
          <main class="markdown-body" slot="markdown-html"></main>
        </marked-element>
      </template>

      <template is="dom-if" if="[[doc.url]]">
        <marked-element markdown="[[_markdown]]" sanitize sanitizer="[[sanitizer]]">
          <main class="markdown-body" slot="markdown-html"></main>
          <script type="text/markdown" src="[[doc.url]]"></script>
        </marked-element>
      </template>

      <template is="dom-if" if="[[doc.contents]]">
        <div style="margin-top: 20px;">
          <paper-input always-float-label label="Title" value="{{doc.title}}" hidden="[[!_edit]]"></paper-input>
          <paper-input always-float-label label="Description" value="{{doc.desc}}" hidden="[[!_edit]]"></paper-input>
          <paper-input always-float-label label="Order" value="{{doc.order}}" hidden="[[!_edit]]"></paper-input>
          <paper-textarea value="{{doc.contents}}" hidden="[[!_edit]]"></paper-textarea>
        </div>
      </template>

    </app-header-layout>


  </template>
  <script>
    class PolymerJpMarked extends Polymer.Element {
      static get is() { return 'polymer-jp-marked' }
      static get properties() {
        return {
          doc: Object,
          _markdown: {
            type: String,
            computed: "_emojify(doc.contents)"
          }
        }
      }
      constructor(){
        super()
        this.styleTheme='prism-theme-default'
      }
      static get observers() {
        return [
          '_contentsChanged(doc.*)'
        ]
      }
      _contentsChanged(e){
        if(e.path.lastIndexOf('doc.')==0 && this._edit){
          let data = {};
          const key = e.path.substr(4);
          data[key]= key == 'order' ? parseInt(e.value) : e.value;
          firebase.firestore().collection('docs').doc(e.base.__id__).update(data);
        }
      }
      _emojify(contents){
        if (contents) return emojione.toImage(contents)
      }
    }
    customElements.define(PolymerJpMarked.is, PolymerJpMarked)
  </script>
</dom-module>
